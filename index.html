<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CareMarket v4 – 수수료/배송비/환율 설정 & 계산</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif; margin:24px;}
    h1{ font-size:24px; margin:0 0 8px 0;}
    .hint{ color:var(--muted); margin-bottom:16px; }
    .card{ background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px; margin-top:16px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; }
    thead th{ position:sticky; top:0; background:#0b1220; color:#cbd5e1; font-weight:600; padding:10px; border-bottom:1px solid #243144;}
    tbody td{ padding:10px; border-bottom:1px solid #1f2a3a; text-align:center;}
    input[type="number"], input[type="text"]{ width:100%; padding:6px 8px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:var(--text); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; }
    .row > div{ flex:1 1 200px; }
    button{ background:var(--accent); border:0; color:#003041; font-weight:700; padding:10px 14px; border-radius:10px; cursor:pointer;}
    .btn-ghost{ background:#192232; color:#cbd5e1; }
    .right{ text-align:right;}
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small{ font-size:12px; color:#93a4bb;}
  </style>
</head>
<body>
  <h1>CareMarket v4</h1>
  <div class="small">· <span class="mono">config.json</span>에서 국가별 설정을 불러와 사용 · 세금(<span class="mono">taxPct</span>) + 쇼피/PG 수수료 + 고정비까지 계산</div>

  <div class="card">
    <h2>국가(마켓) 수수료·세금·보조금·환율</h2>
    <div class="small">표는 <span class="mono">config.json</span> 또는 로컬 저장값을 표시합니다.</div>
    <table id="marketTable">
      <thead>
        <tr>
          <th>코드</th>
          <th>이름</th>
          <th>통화</th>
          <th>판매수수료</th>
          <th>결제대행수수료</th>
          <th>세금</th>
          <th>PG인출 수수료</th>
          <th>서비스수수료</th>
          <th>플랫폼고정</th>
          <th>배송비</th>
          <th>환율(KRW→현지)</th>
          <th>삭제</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>계산기</h2>
    <div class="row">
      <div><label>판매가(현지통화)<br><input id="price" type="number" step="0.01" value="15"></label></div>
      <div><label>원가(KRW)<br><input id="costKRW" type="number" step="1" value="5000"></label></div>
      <div><label>셀러부담 배송비(현지통화)<br><input id="sellerShip" type="number" step="0.01" value="0"></label></div>
    </div>
    <div style="margin-top:12px;">
      <button onclick="calculate()">계산하기</button>
      <button class='btn-ghost' onclick="clearLocal()">로컬 저장값 초기화</button>
    </div>
    <div id="result" class="card" style="margin-top:16px;"></div>
  </div>

<script>
const LS_KEY = 'markets_v4_ext';

async function loadConfig(){
  try{
    const res = await fetch('config.json');
    const json = await res.json();
    let markets = json.markets || [];
    const saved = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if(saved && Array.isArray(saved) && saved.length) markets = saved;
    renderMarkets(markets);
  }catch(e){
    console.error(e);
    renderMarkets([]);
  }
}

function persist(markets){
  localStorage.setItem(LS_KEY, JSON.stringify(markets));
}

function renderMarkets(markets){
  const tbody = document.querySelector('#marketTable tbody');
  tbody.innerHTML = markets.map((m,i)=>`
    <tr>
      <td>${m.id}</td>
      <td>${m.name}</td>
      <td>${m.currency}</td>
      <td><input type="number" step="0.0001" data-i="${i}" data-k="commissionPct" value="${m.commissionPct ?? 0}"></td>
      <td><input type="number" step="0.0001" data-i="${i}" data-k="transPct" value="${m.transPct ?? 0}"></td>
      <td><input type="number" step="0.0001" data-i="${i}" data-k="taxPct" value="${m.taxPct ?? 0}"></td>
      <td><input type="number" step="0.0001" data-i="${i}" data-k="pgWithdrawPct" value="${m.pgWithdrawPct ?? 0}"></td>
      <td><input type="number" step="0.0001" data-i="${i}" data-k="servicePct" value="${m.servicePct ?? 0}"></td>
      <td><input type="number" step="0.01" data-i="${i}" data-k="infraFixed" value="${m.infraFixed ?? 0}"></td>
      <td><input type="number" step="0.01" data-i="${i}" data-k="ship" value="${m.ship ?? 0}"></td>
      <td><input type="number" step="0.0001" data-i="${i}" data-k="fx" value="${m.fx ?? 1}"></td>
      <td><button class="btn-ghost" onclick="removeRow(${i})">삭제</button></td>
    </tr>
  `).join('');

  tbody.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const i = +inp.dataset.i;
      const k = inp.dataset.k;
      markets[i][k] = Number(inp.value);
      persist(markets);
    });
  });

  window._markets = markets;
  persist(markets);
}

function removeRow(i){
  const mkts = window._markets || [];
  mkts.splice(i,1);
  renderMarkets(mkts);
}

function clearLocal(){
  localStorage.removeItem(LS_KEY);
  loadConfig();
}

function fmt(n){ return Number(n).toLocaleString(undefined,{maximumFractionDigits:4}); }

function calculate(){
  const price = Number(document.getElementById('price').value||0);
  const costKRW = Number(document.getElementById('costKRW').value||0);
  const sellerShip = Number(document.getElementById('sellerShip').value||0);
  const markets = window._markets || [];

  const rows = markets.map(m=>{
    const costLocal = costKRW * (m.fx||1);
    const commission = price * (m.commissionPct||0);
    const transFee  = price * (m.transPct||0);
    const taxFee    = price * (m.taxPct||0);
    const pgFee     = price * (m.pgWithdrawPct||0);
    const service   = price * (m.servicePct||0);
    const fixed     = (m.infraFixed||0);
    const ship      = (m.ship||0);
    const totalFees = commission + transFee + taxFee + pgFee + service + fixed + ship + sellerShip;
    const profit    = price - totalFees - costLocal;
    const margin    = price ? (profit/price*100) : 0;

    return {
      id:m.id, name:m.name, currency:m.currency,
      commission, transFee, taxFee, pgFee, service, fixed, ship, fx:m.fx||1,
      costLocal, sellerShip, totalFees, profit, margin
    };
  });

  const html = `
  <h3>결과</h3>
  <div class="small">판매가: <b>${fmt(price)}</b>, 원가(KRW): <b>${fmt(costKRW)}</b>, 셀러부담 배송비: <b>${fmt(sellerShip)}</b></div>
  <table>
    <thead>
      <tr>
        <th>코드</th><th>이름</th><th>통화</th>
        <th>판매수수료</th><th>결제대행수수료</th><th>세금</th>
        <th>PG인출 수수료</th><th>서비스수수료</th>
        <th>플랫폼고정</th><th>배송비</th><th>환율</th>
        <th>원가(현지)</th><th>총수수료(+셀러배송)</th>
        <th>순이익</th><th>마진%</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${r.id}</td>
          <td>${r.name}</td>
          <td>${r.currency}</td>
          <td>${fmt(r.commission)}</td>
          <td>${fmt(r.transFee)}</td>
          <td>${fmt(r.taxFee)}</td>
          <td>${fmt(r.pgFee)}</td>
          <td>${fmt(r.service)}</td>
          <td>${fmt(r.fixed)}</td>
          <td>${fmt(r.ship)}</td>
          <td>${fmt(r.fx)}</td>
          <td>${fmt(r.costLocal)}</td>
          <td>${fmt(r.totalFees)}</td>
          <td>${fmt(r.profit)}</td>
          <td>${fmt(r.margin)}</td>
        </tr>
      `).join('')}
    </tbody>
  </table>`;

  document.getElementById('result').innerHTML = html;
}

loadConfig();
</script>
</body>
</html>
